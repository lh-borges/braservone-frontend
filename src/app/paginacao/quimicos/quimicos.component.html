<div class="shell">
  <app-header class="header"></app-header>

  <aside class="sidebar border-end">
    <app-menu-lateral></app-menu-lateral>
  </aside>

  <main class="content">
    <div class="container-fluid py-4">

      

      <div class="row mb-4 px-2">
        <div class="col-12">
          <div class="d-flex flex-column">
            <h2 class="fw-bold m-0" style="color: #1a1f36;">Gerenciamento de Químicos</h2>
            <p class="text-muted small mb-0">Controle de estoque, validade e movimentações</p>
          </div>
        </div>
      </div>

      <div class="row px-2 mb-3">
        <div class="col-12">
          <ul class="nav nav-pills gap-2" role="tablist" style="font-size: 0.9rem;">
            <li class="nav-item" role="presentation">
              <button class="nav-link fw-semibold px-4" 
                      [class.active]="activeTab==='cadastro'" 
                      [class.bg-white]="activeTab!=='cadastro'"
                      [class.shadow-sm]="activeTab!=='cadastro'"
                      (click)="setTab('cadastro')" 
                      type="button"
                      style="border-radius: 8px;">
                <i class="bi bi-box-seam me-2"></i> Cadastro
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link fw-semibold px-4" 
                      [class.active]="activeTab==='mov'" 
                      [class.bg-white]="activeTab!=='mov'"
                      [class.shadow-sm]="activeTab!=='mov'"
                      (click)="setTab('mov')" 
                      type="button"
                      style="border-radius: 8px;">
                <i class="bi bi-arrow-left-right me-2"></i> Movimentação
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link fw-semibold px-4" 
                      [class.active]="activeTab==='estoque'" 
                      [class.bg-white]="activeTab!=='estoque'"
                      [class.shadow-sm]="activeTab!=='estoque'"
                      (click)="setTab('estoque')" 
                      type="button"
                      style="border-radius: 8px;">
                <i class="bi bi-clipboard-data me-2"></i> Estoque Atual
              </button>
            </li>
          </ul>
        </div>
      </div>

      <div class="row px-2">
        <div class="col-12">
          <ng-container [ngSwitch]="activeTab">

            <div *ngSwitchCase="'cadastro'">

              <div class="card-soft p-4 mb-4">
                <div class="row g-3 align-items-end">
                  <div class="col-12 col-md-4">
                    <label class="text-label mb-2 d-block">Pesquisar Químico</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-search"></i></span>
                      <input type="text" class="form-control bg-light border-start-0 ps-0"
                             placeholder="Código, fornecedor, lote..."
                             [(ngModel)]="searchTerm" />
                    </div>
                  </div>

                  <div class="col-6 col-md-3">
                    <label class="text-label mb-2 d-block">Status</label>
                    <select class="form-select" [(ngModel)]="statusFiltro">
                      <option value="TODOS">Todos</option>
                      <option value="ATIVO">Ativo</option>
                      <option value="FINALIZADO">Finalizado</option>
                    </select>
                  </div>

                  <div class="col-6 col-md-3">
                    <label class="text-label mb-2 d-block">Estado (UF)</label>
                    <select class="form-select" [(ngModel)]="estadoFiltro">
                      <option value="TODOS">Todos</option>
                      <option *ngFor="let e of estados" [value]="e">{{ e }}</option>
                    </select>
                  </div>

                  <div class="col-6 col-md-2 d-grid">
                    <button class="btn btn-primary fw-semibold" (click)="onPesquisar()">
                      Filtrar
                    </button>
                  </div>
                  
                  <div class="col-12 d-flex justify-content-end mt-3 border-top pt-3">
                    <button class="btn btn-success text-white fw-bold d-flex align-items-center gap-2 shadow-sm" 
                            (click)="novoQuimico()"
                            style="border-radius: 8px; padding: 0.6rem 1.2rem;">
                      <i class="bi bi-plus-lg"></i> Novo Químico
                    </button>
                  </div>
                </div>
              </div>

              <div class="card-soft mb-4 p-4 border-start border-4 border-primary" [hidden]="!exibirFormulario">
                <div class="d-flex align-items-center gap-2 mb-4">
                  <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <i class="bi bi-pencil-fill small"></i>
                  </div>
                  <h5 class="fw-bold m-0 text-dark">Dados do Químico</h5>
                </div>

                <div *ngIf="carregandoForm" class="alert alert-light d-flex align-items-center gap-2 mb-3">
                  <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                  <span class="text-muted">Carregando dados...</span>
                </div>

                <fieldset [disabled]="formBusy">
                  <div class="row g-3">
                    <div class="col-md-3">
                      <label class="form-label small text-muted fw-bold">Tipo *</label>
                      <select class="form-select" [(ngModel)]="novo.tipoQuimico">
                        <option [ngValue]="null">Selecione...</option>
                        <option *ngFor="let t of tiposQuimico" [ngValue]="t">{{ t }}</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small text-muted fw-bold">Fornecedor *</label>
                      <select class="form-select"
                              [(ngModel)]="novo.fornecedorId"
                              [disabled]="formBusy || carregandoFornecedores">
                        <option [ngValue]="null">Selecione...</option>
                        <option *ngFor="let f of fornecedores" [ngValue]="f.id">{{ f.nome }}</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small text-muted fw-bold">Lote</label>
                      <input type="text" class="form-control" [(ngModel)]="novo.lote" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small text-muted fw-bold">Valor (R$)</label>
                      <input type="number" step="0.01" class="form-control" [(ngModel)]="novo.valorQuimico" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small text-muted fw-bold">Unidade *</label>
                      <select class="form-select" [(ngModel)]="novo.unidade">
                        <option [ngValue]="null">Selecione...</option>
                        <option *ngFor="let u of unidadesOptions" [ngValue]="u.code">{{ u.label }}</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small text-muted fw-bold">Estoque Inicial *</label>
                      <input type="number" step="0.000001" class="form-control" [(ngModel)]="novo.estoqueInicial" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small text-muted fw-bold">Data Compra</label>
                      <input type="date" class="form-control" [(ngModel)]="novo.dataCompraDateInput" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label small text-muted fw-bold">Validade</label>
                      <input type="date" class="form-control" [(ngModel)]="novo.dataValidadeDateInput" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small text-muted fw-bold">Status *</label>
                      <select class="form-select" [(ngModel)]="novo.statusQuimicos">
                        <option *ngFor="let s of statusOptions" [value]="s">{{ s }}</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label small text-muted fw-bold">UF Armazenado</label>
                      <select class="form-select" [(ngModel)]="novo.estadoLocalArmazenamento">
                        <option [ngValue]="null">...</option>
                        <option *ngFor="let e of estados" [ngValue]="e">{{ e }}</option>
                      </select>
                    </div>
                    <div class="col-12">
                      <label class="form-label small text-muted fw-bold">Observação</label>
                      <textarea rows="2" class="form-control"
                                [(ngModel)]="novo.observacao"
                                placeholder="Detalhes adicionais..."></textarea>
                    </div>
                  </div>
                </fieldset>

                <div class="mt-4 d-flex justify-content-end gap-2 border-top pt-3">
                  <button class="btn btn-light text-secondary border" [disabled]="salvando" (click)="cancelarCadastro()">
                    Cancelar
                  </button>
                  <button class="btn btn-success text-white px-4 fw-semibold" [disabled]="formBusy" (click)="salvarQuimico()">
                    <span *ngIf="salvando" class="spinner-border spinner-border-sm me-2"></span>
                    {{ salvando ? 'Salvando...' : labelSalvar }}
                  </button>
                </div>
              </div>

              <div class="table-container">
                <div *ngIf="carregando" class="p-5 text-center text-muted">
                   <div class="spinner-border text-primary mb-2" role="status"></div>
                   <p class="mb-0">Carregando lista...</p>
                </div>

                <div class="table-responsive" *ngIf="!carregando">
                  <table class="table-soft">
                    <thead>
                      <tr>
                        <th class="ps-4">Código</th>
                        <th>Tipo</th>
                        <th>Fornecedor</th>
                        <th>Lote</th>
                        <th class="text-center">Inicial</th>
                        <th class="text-center">Utilizado</th>
                        <th class="text-center">Atual</th>
                        <th>Valor</th>
                        <th>Validade</th>
                        <th>UF</th>
                        <th>Obs.</th>
                        <th class="text-end pe-4">Ações</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let q of quimicosFiltrados; trackBy: trackByCodigo">
                        <td class="ps-4 fw-semibold text-dark">#{{ q.codigo }}</td>
                        <td>
                          <span style="background: #eef2ff; color: #4f46e5; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 0.75rem;">
                            {{ q.tipoQuimico }}
                          </span>
                        </td>
                        <td>{{ q.fornecedor?.nome || '-' }}</td>
                        <td class="text-muted font-monospace">{{ q.lote || '-' }}</td>

                        <td class="text-center">{{ fmtEstoque(q) }}</td>
                        <td class="text-center text-muted">{{ fmtEstoqueUtilizado(q) }}</td>
                        <td class="text-center fw-bold" style="color: #059669;">{{ fmtEstoqueAtual(q) }}</td>

                        <td>{{ q.valorQuimico ? ('R$ ' + q.valorQuimico) : '-' }}</td>
                        <td>
                          <span [class.text-danger]="!q.dataValidade">
                             {{ q.dataValidade ? (q.dataValidade | date: 'dd/MM/yyyy') : 'N/D' }}
                          </span>
                        </td>
                        <td>{{ q.estadoLocalArmazenamento || '-' }}</td>
                        <td>
                          <span class="d-inline-block text-truncate text-muted" style="max-width: 100px;" [title]="q.observacao">
                            {{ q.observacao || '-' }}
                          </span>
                        </td>
                        <td class="text-end pe-4">
                          <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-sm btn-light border" style="color: #6366f1;" (click)="onEditar(q)" title="Editar">
                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16">
                                <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                              </svg>
                            </button>
                            <button class="btn btn-sm btn-light border" style="color: #ef4444;" (click)="onExcluir(q)" title="Excluir">
                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                                <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                              </svg>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr *ngIf="quimicosFiltrados.length === 0">
                        <td colspan="12" class="text-center p-5">
                          <div class="text-muted opacity-50 mb-2"><i class="bi bi-inbox display-4"></i></div>
                          <h6 class="text-muted">Nenhum químico encontrado.</h6>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>

            <div *ngSwitchCase="'mov'">
              <div *ngIf="loadingMovCmp" class="alert alert-light d-flex align-items-center gap-2 m-3">
                 <span class="spinner-border spinner-border-sm text-primary"></span>
                 Carregando componente de movimentação...
              </div>
              <ng-container *ngIf="movCmpType">
                <ng-container *ngComponentOutlet="movCmpType"></ng-container>
              </ng-container>
            </div>

            <div *ngSwitchCase="'estoque'">
              <div *ngIf="loadingEstoqueCmp" class="alert alert-light d-flex align-items-center gap-2 m-3">
                 <span class="spinner-border spinner-border-sm text-primary"></span>
                 Carregando componente de estoque...
              </div>
              <ng-container *ngIf="estoqueCmpType">
                <ng-container *ngComponentOutlet="estoqueCmpType"></ng-container>
              </ng-container>
            </div>

            <div *ngSwitchDefault class="text-muted p-5 text-center">
              Selecione uma aba para começar.
            </div>
          </ng-container>
        </div>
      </div>

    </div>
  </main>
</div>