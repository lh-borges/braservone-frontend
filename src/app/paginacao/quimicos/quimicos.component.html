<div class="shell">
  <app-header class="header"></app-header>

  <aside class="sidebar border-end">
    <app-menu-lateral></app-menu-lateral>
  </aside>

  <main class="content">
    <div class="container-fluid py-3">

      <div
        class="page-hero bg-primary text-white rounded shadow-sm d-flex flex-column flex-md-row align-items-center justify-content-between gap-3 p-4 mb-3">
        <h2 class="m-0 fw-bold">Químicos</h2>
      </div>

      <div class="card shadow-sm">
        <div class="card-header p-0 bg-white border-bottom-0 mb-3">
          <ul class="nav nav-tabs card-header-tabs px-3" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeTab==='cadastro'" (click)="setTab('cadastro')" type="button">
                Cadastro
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeTab==='mov'" (click)="setTab('mov')" type="button">
                Movimentação
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeTab==='estoque'" (click)="setTab('estoque')" type="button">
                Estoque Atual
              </button>
            </li>
          </ul>
        </div>

        <div class="card-body">
          <ng-container [ngSwitch]="activeTab">

            <!-- ============= CADASTRO ============= -->
            <div *ngSwitchCase="'cadastro'">

              <div class="filter-bar bg-white rounded shadow-sm border p-3 mb-3">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-5">
                    <label class="form-label mb-1">Pesquisar Químico</label>
                    <input type="text" class="form-control"
                           placeholder="Digite código, fornecedor, lote ou tipo..."
                           [(ngModel)]="searchTerm" />
                  </div>

                  <div class="col-6 col-md-3">
                    <label class="form-label mb-1">Status</label>
                    <select class="form-select" [(ngModel)]="statusFiltro">
                      <option value="TODOS">Todas</option>
                      <option value="ATIVO">Ativo</option>
                      <option value="FINALIZADO">Finalizado</option>
                    </select>
                  </div>

                  <div class="col-6 col-md-2">
                    <label class="form-label mb-1 d-none d-md-block">&nbsp;</label>
                    <button class="btn btn-primary w-100" (click)="onPesquisar()">Pesquisar</button>
                  </div>

                  <div class="col-12 col-md-2">
                    <label class="form-label mb-1 d-none d-md-block">&nbsp;</label>
                    <button class="btn btn-success w-100 fw-semibold" (click)="novoQuimico()">+ Adicionar Químico</button>
                  </div>
                </div>
              </div>

              <!-- Form -->
              <div class="card mb-4" [hidden]="!exibirFormulario">
                <div class="card-body">

                  <div *ngIf="carregandoForm" class="alert alert-light d-flex align-items-center gap-2 mb-3">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span>Carregando dados do químico...</span>
                  </div>

                  <fieldset [disabled]="formBusy">
                    <div class="row g-3">

                      <div class="col-md-3">
                        <label for="tipoQuimico" class="form-label">Tipo *</label>
                        <select id="tipoQuimico" class="form-select" [(ngModel)]="novo.tipoQuimico">
                          <option [ngValue]="null">Selecione...</option>
                          <option *ngFor="let t of tiposQuimico" [ngValue]="t">{{ t }}</option>
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label for="fornecedorId" class="form-label">Fornecedor *</label>
                        <select id="fornecedorId"
                                class="form-select"
                                [(ngModel)]="novo.fornecedorId"
                                [disabled]="formBusy || carregandoFornecedores">
                          <option [ngValue]="null">Selecione...</option>
                          <option *ngFor="let f of fornecedores" [ngValue]="f.id">{{ f.nome }}</option>
                        </select>
                        <small class="text-muted" *ngIf="carregandoFornecedores">Carregando fornecedores…</small>
                      </div>

                      <div class="col-md-2">
                        <label for="lote" class="form-label">Lote</label>
                        <input id="lote" type="text" class="form-control" [(ngModel)]="novo.lote" />
                      </div>

                      <div class="col-md-2">
                        <label for="valorQuimico" class="form-label">Valor (R$)</label>
                        <input id="valorQuimico" type="number" step="0.01" class="form-control"
                               [(ngModel)]="novo.valorQuimico" />
                      </div>

                      <div class="col-md-2">
                        <label for="unidade" class="form-label">Unidade *</label>
                        <select id="unidade" class="form-select" [(ngModel)]="novo.unidade">
                          <option [ngValue]="null">Selecione...</option>
                          <option *ngFor="let u of unidadesOptions" [ngValue]="u.code">{{ u.label }}</option>
                        </select>
                      </div>

                      <div class="col-md-2">
                        <label for="estoqueInicial" class="form-label">Estoque Inicial *</label>
                        <input id="estoqueInicial" type="number" step="0.000001" class="form-control"
                               [(ngModel)]="novo.estoqueInicial" />
                      </div>

                      <div class="col-md-3">
                        <label for="dataCompra" class="form-label">Data da compra</label>
                        <input id="dataCompra" type="date" class="form-control"
                               [(ngModel)]="novo.dataCompraDateInput" />
                      </div>

                      <div class="col-md-3">
                        <label for="dataValidade" class="form-label">Data de validade</label>
                        <input id="dataValidade" type="date" class="form-control"
                               [(ngModel)]="novo.dataValidadeDateInput" />
                      </div>

                      <div class="col-md-3">
                        <label for="statusQuimicos" class="form-label">Status *</label>
                        <select id="statusQuimicos" class="form-select" [(ngModel)]="novo.statusQuimicos">
                          <option *ngFor="let s of statusOptions" [value]="s">{{ s }}</option>
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label for="estadoLocalArmazenamento" class="form-label">Estado armazenado</label>
                        <select id="estadoLocalArmazenamento" class="form-select"
                                [(ngModel)]="novo.estadoLocalArmazenamento">
                          <option [ngValue]="null">Selecione...</option>
                          <option *ngFor="let e of estados" [ngValue]="e">{{ e }}</option>
                        </select>
                      </div>

                      <div class="col-12">
                        <label for="observacao" class="form-label">Observação</label>
                        <textarea id="observacao" rows="2" class="form-control"
                                  [(ngModel)]="novo.observacao"
                                  placeholder="Ex.: material sensível à umidade, manter em local seco"></textarea>
                      </div>

                    </div>
                  </fieldset>

                  <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-success" [disabled]="formBusy" (click)="salvarQuimico()">
                      <span *ngIf="salvando" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                      <span>{{ salvando ? 'Salvando...' : labelSalvar }}</span>
                    </button>

                    <button class="btn btn-outline-secondary" [disabled]="salvando" (click)="cancelarCadastro()">
                      Cancelar
                    </button>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card-body p-0">
                  <div *ngIf="carregando" class="p-3">Carregando...</div>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                      <thead class="table-light sticky-top">
                        <tr>
                          <th>Código</th>
                          <th>Tipo</th>
                          <th>Fornecedor</th>
                          <th>Lote</th>
                          <th>Estoque inicial</th> <!-- concatena quantidade + unidade -->
                          <th>Valor</th>
                          <th>Data compra</th>
                          <th>Validade</th>
                          <th>Estado</th>
                          <th>Obs.</th>
                          <th class="text-end">Ações</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let q of quimicosFiltrados; trackBy: trackByCodigo">
                          <td>{{ q.codigo }}</td>
                          <td>{{ q.tipoQuimico }}</td>
                          <td>{{ q.fornecedor?.nome || '-' }}</td>
                          <td>{{ q.lote || '-' }}</td>
                          <td class="text-nowrap">{{ fmtEstoque(q) }}</td>
                          <td>{{ q.valorQuimico ?? '-' }}</td>
                          <td>{{ q.dataCompra ? (q.dataCompra | date: 'yyyy-MM-dd') : '-' }}</td>
                          <td>{{ q.dataValidade ? (q.dataValidade | date: 'yyyy-MM-dd') : '-' }}</td>
                          <td>{{ q.estadoLocalArmazenamento || '-' }}</td>
                          <td>
                            <span class="d-inline-block text-truncate" style="max-width: 140px;"
                                  [title]="q.observacao">
                              {{ q.observacao || '-' }}
                            </span>
                          </td>
                          <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-2" (click)="onEditar(q)">Editar</button>
                            <button class="btn btn-sm btn-outline-danger" (click)="onExcluir(q)">Excluir</button>
                          </td>
                        </tr>
                        <tr *ngIf="!carregando && quimicosFiltrados.length === 0">
                          <td colspan="11" class="text-center p-3 text-muted">Nenhum químico encontrado.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>

            <!-- ============= MOVIMENTAÇÃO (LAZY) ============= -->
            <div *ngSwitchCase="'mov'">
              <div *ngIf="loadingMovCmp" class="text-muted">Carregando movimentação...</div>
              <ng-container *ngIf="movCmpType">
                <ng-container *ngComponentOutlet="movCmpType"></ng-container>
              </ng-container>
            </div>

            <!-- ============= ESTOQUE ATUAL (LAZY) ============= -->
            <div *ngSwitchCase="'estoque'">
              <div *ngIf="loadingEstoqueCmp" class="text-muted">Carregando estoque...</div>
              <ng-container *ngIf="estoqueCmpType">
                <ng-container *ngComponentOutlet="estoqueCmpType"></ng-container>
              </ng-container>
            </div>

            <div *ngSwitchDefault class="text-muted">Selecione uma aba.</div>
          </ng-container>
        </div>
      </div>

    </div>
  </main>
</div>
