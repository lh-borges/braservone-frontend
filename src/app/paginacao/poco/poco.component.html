<div class="alert alert-soft-success floating-alert" *ngIf="alertSucess" role="alert">
    <i class="bi bi-check-circle-fill me-2"></i> Operação concluída com sucesso.
</div>

<div class="shell">
    <app-header class="header"></app-header>

    <aside class="sidebar border-end">
        <app-menu-lateral></app-menu-lateral>
    </aside>

    <main class="content">
        <div class="container-fluid p-4">
            <div class="row g-4">
                
                <div class="col-12">
                    <div class="poco-header-bar accent-info m-3">
                        <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center p-4">
                            <h2 class="text-dark-title fw-bold m-0">Poços Cadastrados</h2>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-soft-clean" (click)="openImport()">Importar do CSV</button>
                                <button class="btn btn-white" (click)="onAdd()">+ Adicionar Poço</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card-soft p-4 m-3 position-sticky filter-sticky">
                        <div class="row g-3 align-items-end">
                            <div class="col-12 col-lg-6">
                                <label for="searchPocos" class="form-label text-muted-label mb-2">PESQUISAR NA PÁGINA ATUAL</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input
                                        id="searchPocos"
                                        type="text"
                                        class="form-control"
                                        placeholder="Código ANP, bacia, status, campo ou local..."
                                        [(ngModel)]="searchTerm"
                                        (input)="applyFilter()"
                                    />
                                    <button class="btn btn-outline-secondary btn-soft-clean" type="button" (click)="clearSearch()">Limpar</button>
                                </div>
                            </div>

                            <div class="col-6 col-lg-2">
                                <label class="form-label text-muted-label">Ordenar</label>
                                <div class="d-grid">
                                    <button class="btn btn-outline-secondary btn-soft-clean" (click)="setSort('codigoAnp')">
                                        código ANP
                                        <i class="bi"
                                        [ngClass]="{
                                            'bi-sort-alpha-down': sort[0] && sort[0].endsWith(',asc'),
                                            'bi-sort-alpha-up': sort[0] && sort[0].endsWith(',desc')
                                        }"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-6 col-lg-2">
                                <label for="pageSize" class="form-label text-muted-label">Itens por página</label>
                                <select id="pageSize" class="form-select" [ngModel]="pageSize" (ngModelChange)="changePageSize($event)">
                                    <option *ngFor="let s of pageSizeOptions" [ngValue]="s">{{ s }}</option>
                                </select>
                            </div>

                            <div class="col-12 col-lg-2 text-lg-end">
                                <small class="text-muted-light d-block" *ngIf="!loading && totalElements > 0">
                                    Mostrando {{ firstItemIndex() }}–{{ lastItemIndex() }} de {{ totalElements }}
                                </small>
                                <small class="text-muted-light d-block" *ngIf="loading">Carregando...</small>
                            </div>
                        </div>

                        <div class="row mt-4 pt-3 border-top border-light">
                            <div class="col d-flex gap-2 justify-content-end">
                                <span class="align-self-center small text-muted-light me-3">
                                    Página {{ pageIndex + 1 }} / {{ totalPages || 1 }}
                                </span>
                                <button class="btn btn-outline-secondary btn-soft-clean" (click)="goPrev()" [disabled]="!canPrev()">
                                    <i class="bi bi-chevron-left"></i> Anterior
                                </button>
                                <button class="btn btn-outline-secondary btn-soft-clean" (click)="goNext()" [disabled]="!canNext()">
                                    Próxima <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <div class="text-danger-soft mt-2 small" *ngIf="errorMsg">{{ errorMsg }}</div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="row g-4 px-3 pb-4">
                        <ng-container *ngFor="let p of filteredPocos; trackBy: trackByCod">
                            <div class="col-md-4 col-lg-3 col-sm-6">
                                <div class="card-soft h-100 p-0 accent-info-light">
                                    <div class="card-body">
                                        <h5 class="card-title text-dark-title fw-bold mb-3">
                                            {{ p.codigoAnp }}
                                        </h5>
                                        <div class="card-text text-muted-light small mb-4">
                                            <p class="m-0"><span class="fw-semibold">Bacia:</span> {{ p.bacia || '—' }}</p>
                                            <p class="m-0"><span class="fw-semibold">Campo:</span> {{ p.nomeCampo || '—' }}</p>
                                            <p class="m-0"><span class="fw-semibold">Local:</span> {{ p.local || '—' }}</p>
                                            <p class="m-0"><span class="fw-semibold">Status:</span> 
                                                <span class="status-tag" 
                                                    [ngClass]="p.status === 'Produzindo' ? 'status-success' : 'status-secondary'">
                                                    {{ p.status || '—' }}
                                                </span>
                                            </p>
                                        </div>
                                        <div class="d-flex justify-content-end gap-2 border-top pt-3 border-light">
                                            <button class="btn btn-outline-secondary btn-soft-clean btn-sm">
                                                <i class="bi bi-eye-fill"></i>
                                            </button>
                                            <button class="btn btn-soft-warning btn-sm" (click)="onEdit(p)">
                                                <i class="bi bi-pencil-fill"></i> Editar
                                            </button>
                                            <button
                                                class="btn btn-soft-danger btn-sm"
                                                (click)="delete(p)"
                                                [disabled]="deleting.has(getCodigo(p))">
                                                <span *ngIf="deleting.has(getCodigo(p))"
                                                        class="spinner-border spinner-border-sm me-1"></span>
                                                <i *ngIf="!deleting.has(getCodigo(p))" class="bi bi-trash-fill"></i> Excluir
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-container>

                        <div class="col-12" *ngIf="!loading && filteredPocos.length === 0">
                            <div class="card-soft p-4 text-center text-muted-light">
                                Nenhum poço corresponde à pesquisa.
                            </div>
                        </div>
                    </div>
                </div>
            </div> 
        </div> 
    </main>
</div>

<div
    class="modal fade show d-block createPoco"
    tabindex="-1"
    role="dialog"
    *ngIf="showAdd"
    style="background: rgba(0,0,0,.5);"
>
    <div class="modal-dialog" role="document">
        <div class="modal-content accent-info card-soft">
            <form #addForm="ngForm" (ngSubmit)="$event.preventDefault()">
                <div class="modal-header border-bottom border-light pb-3">
                    <h5 class="modal-title text-dark-title">
                        {{ adicionar ? 'Novo Poço' : 'Editar Poço' }}
                    </h5>
                    <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="codigoAnp" class="form-label text-muted-label">Código ANP *</label>
                            <input
                                id="codigoAnp"
                                name="codigoAnp"
                                class="form-control"
                                [(ngModel)]="newPoco.codigoAnp"
                                required
                                maxlength="64"
                                placeholder="Ex.: 7-CARM-103-SE"
                            />
                            <div class="text-danger-soft small mt-1" *ngIf="addForm.submitted && !newPoco.codigoAnp">
                                Informe o código ANP.
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="nomeCampo" class="form-label text-muted-label">Nome do Campo</label>
                            <input
                                id="nomeCampo"
                                name="nomeCampo"
                                class="form-control"
                                [(ngModel)]="newPoco.nomeCampo"
                                maxlength="120"
                                placeholder="Ex.: Carmópolis"
                            />
                        </div>

                        <div class="col-md-4">
                            <label for="bacia" class="form-label text-muted-label">Bacia (opcional)</label>
                            <select
                                id="bacia"
                                name="bacia"
                                class="form-select"
                                [(ngModel)]="newPoco.bacia">
                                <option [ngValue]="undefined">Selecione...</option>
                                <option *ngFor="let b of bacias" [ngValue]="b">{{ b }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mt-3">
                        <div class="col-md-3">
                            <label for="status" class="form-label text-muted-label">Status</label>
                            <select
                                id="status"
                                name="status"
                                class="form-select"
                                [(ngModel)]="newPoco.status">
                                <option [ngValue]="undefined">Selecione...</option>
                                <option *ngFor="let s of statusList" [ngValue]="s">{{ s }}</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="fluido" class="form-label text-muted-label">Fluido</label>
                            <select
                                id="fluido"
                                name="fluido"
                                class="form-select"
                                [(ngModel)]="newPoco.fluido">
                                <option [ngValue]="undefined">Selecione...</option>
                                <option *ngFor="let f of fluidos" [ngValue]="f.value">{{ f.label }}</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="local" class="form-label text-muted-label">Local</label>
                            <input
                                id="local"
                                name="local"
                                class="form-control"
                                [(ngModel)]="newPoco.local"
                                maxlength="120"
                                placeholder="Ex.: Carmópolis/SE"
                            />
                        </div>

                        <div class="col-md-3">
                            <label for="tipoPoco" class="form-label text-muted-label">Tipo de Poço *</label>
                            <select
                                id="tipoPoco"
                                name="tipoPoco"
                                class="form-select"
                                [(ngModel)]="newPoco.tipoPoco"
                                required>
                                <option [ngValue]="undefined">Selecione...</option>
                                <option *ngFor="let t of tipoPocoOptions" [ngValue]="t">{{ t }}</option>
                            </select>
                            <div class="text-danger-soft small mt-1" *ngIf="addForm.submitted && !newPoco.tipoPoco">
                                Selecione o tipo do poço.
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-3">
                        <div class="col-md-6">
                            <label for="latitude" class="form-label text-muted-label">Latitude</label>
                            <input
                                id="latitude"
                                name="latitude"
                                class="form-control"
                                type="number"
                                step="0.000001"
                                min="-90"
                                max="90"
                                [(ngModel)]="newPoco.latitude"
                                placeholder="Ex.: -10.123456"
                            />
                        </div>
                        <div class="col-md-6">
                            <label for="longitude" class="form-label text-muted-label">Longitude</label>
                            <input
                                id="longitude"
                                name="longitude"
                                class="form-control"
                                type="number"
                                step="0.000001"
                                min="-180"
                                max="180"
                                [(ngModel)]="newPoco.longitude"
                                placeholder="Ex.: -36.543210"
                            />
                        </div>
                    </div>
                </div>

                <div class="modal-footer pt-3 border-top border-light">
                    <button type="button" class="btn btn-outline-secondary btn-soft-clean" (click)="closeModal()">
                        Cancelar
                    </button>

                    <button
                        *ngIf="adicionar"
                        type="button"
                        class="btn btn-soft-primary"
                        (click)="adicionarPoco()"
                        [disabled]="saving">
                        <span *ngIf="saving" class="spinner-border spinner-border-sm me-1"></span>
                        {{ saving ? 'Salvando...' : 'Salvar' }}
                    </button>

                    <button
                        *ngIf="edit"
                        type="button"
                        class="btn btn-soft-warning"
                        (click)="editarPoco()"
                        [disabled]="saving">
                        <span *ngIf="saving" class="spinner-border spinner-border-sm me-1"></span>
                        {{ saving ? 'Editando...' : 'Editar' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div
    class="modal fade show d-block"
    tabindex="-1"
    role="dialog"
    *ngIf="showImport"
    style="background: rgba(0,0,0,.5);"
>
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content accent-info card-soft">
            <form (ngSubmit)="$event.preventDefault()">
                <div class="modal-header border-bottom border-light pb-3">
                    <h5 class="modal-title text-dark-title">Importar do CSV — múltiplas linhas</h5>
                    <button type="button" class="btn-close" aria-label="Close" (click)="closeImport()"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-soft-info small">
                        <i class="bi bi-info-circle-fill me-2"></i> Ordem esperada dos campos:
                        <code class="text-dark-title fw-medium">codigoAnp;nomeCampo;bacia;status;fluido;local;latitude;longitude;tipoPoco</code><br />
                        Aceita <b>;</b> ou <b>,</b> como separador.
                    </div>

                    <label class="form-label text-muted-label">Linhas CSV</label>
                    <textarea
                        class="form-control"
                        rows="10"
                        [(ngModel)]="csvText"
                        name="csvText"
                        placeholder="Cole aqui várias linhas no formato esperado..."></textarea>

                    <div class="text-danger-soft mt-2 small" *ngIf="csvError">{{ csvError }}</div>
                </div>

                <div class="modal-footer pt-3 border-top border-light">
                    <button
                        type="button"
                        class="btn btn-outline-secondary btn-soft-clean"
                        (click)="closeImport()"
                        [disabled]="importing">
                        Cancelar
                    </button>
                    <button
                        type="button"
                        class="btn btn-soft-success"
                        (click)="addFromCsvText()"
                        [disabled]="importing || !(csvText && csvText.trim())">
                        <span *ngIf="importing" class="spinner-border spinner-border-sm me-1"></span>
                        {{ importing ? 'Importando...' : 'Importar' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>