<!-- TOOLBAR: ações + filtros na MESMA barra -->
<div class="filter-toolbar border rounded bg-white shadow-sm p-3 mb-3">
  <div class="row g-2 align-items-end">

    <!-- Ações -->
    <div class="col-12 col-xl-auto">
      <div class="btn-group">
        <button class="btn btn-outline-primary"
                (click)="carregarTodos()"
                [disabled]="movLoading">
          Carregar todos os movimentos
        </button>
        <button class="btn btn-outline-secondary"
                (click)="movRows = []"
                [disabled]="movLoading">
          Limpar
        </button>
      </div>
    </div>

    <!-- Filtro: TIPO DE QUÍMICO -->
    <div class="col-12 col-sm-6 col-lg-4">
      <label class="form-label mb-1" for="filtroTipoQuimico">Tipo de Químico</label>
      <div class="input-group">
        <select id="filtroTipoQuimico" class="form-select" [(ngModel)]="selectedTipoQuimico">
          <option [ngValue]="undefined">Selecione um tipo...</option>
          <option *ngFor="let t of tiposOptions" [ngValue]="t">{{ t }}</option>
        </select>
        <button class="btn btn-outline-primary"
                (click)="carregarMovPorTipoQuimico(selectedTipoQuimico)"
                [disabled]="!selectedTipoQuimico || movLoading">
          Buscar
        </button>
      </div>
    </div>

    <!-- Filtro: TIPO DE MOVIMENTO -->
    <div class="col-12 col-sm-6 col-lg-3">
      <label class="form-label mb-1" for="filtroTipoMov">Tipo de Movimento</label>
      <div class="input-group">
        <select id="filtroTipoMov" class="form-select" [(ngModel)]="selectedTipoMov">
          <option [ngValue]="undefined">Selecione...</option>
          <option [ngValue]="'ENTRADA'">ENTRADA</option>
          <option [ngValue]="'SAIDA'">SAÍDA</option>
        </select>
        <button class="btn btn-outline-primary"
                (click)="carregarMovPorTipoMovimento(selectedTipoMov)"
                [disabled]="!selectedTipoMov || movLoading">
          Buscar
        </button>
      </div>
    </div>

    <!-- Filtro: POÇO -->
    <div class="col-12 col-sm-6 col-lg-3">
      <label class="form-label mb-1" for="filtroPoco">Poço (código ANP)</label>
      <div class="input-group">
        <select id="filtroPoco" class="form-select" [(ngModel)]="movForm.pocoCodigoAnp">
          <option [ngValue]="''">Selecione um poço...</option>
          <option *ngFor="let p of pocosOptions" [ngValue]="p.codigoAnp">
            {{ p.codigoAnp }}{{ p.nome ? (' — ' + p.nome) : '' }}
          </option>
        </select>
        <button class="btn btn-outline-primary"
                (click)="carregarMovPorPoco(movForm.pocoCodigoAnp)"
                [disabled]="!(movForm.pocoCodigoAnp && movForm.pocoCodigoAnp.length) || movLoading">
          Buscar
        </button>
      </div>
    </div>

    <!-- Busca por LOTE -->
    <div class="col-12 col-lg">
      <label class="form-label mb-1" for="buscaLote">Pesquisar por Lote</label>
      <input id="buscaLote"
             type="text"
             class="form-control"
             placeholder="Digite o lote..."
             [(ngModel)]="loteQuery">
    </div>

    <!-- Abrir formulário -->
    <div class="col-12 col-md-auto">
      <label class="form-label d-none d-md-block mb-1">&nbsp;</label>
      <button class="btn btn-success w-100"
              (click)="mostrarCadastro = !mostrarCadastro"
              [disabled]="movLoading">
        Incluir movimentação
      </button>
    </div>

  </div>
</div>

<!-- FORMULÁRIO DE CADASTRO -->
<div class="card mb-3" *ngIf="mostrarCadastro">
  <div class="card-body">
    <div class="row g-3 align-items-end">

      <div class="col-md-4">
        <label class="form-label" for="cadQuimico">Químico *</label>
        <select id="cadQuimico" class="form-select" [(ngModel)]="movForm.quimicoCodigo">
          <option [ngValue]="undefined">Selecione…</option>
          <option *ngFor="let q of quimicosOptions" [ngValue]="q.codigo">
            {{ q.lote }} — {{ q.tipoQuimico }} ({{ q.fornecedor?.nome || 'Fornecedor' }})
          </option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label" for="cadPoco">Poço (código ANP) *</label>
        <select id="cadPoco" class="form-select" [(ngModel)]="movForm.pocoCodigoAnp">
          <option [ngValue]="''">Selecione…</option>
          <option *ngFor="let p of pocosOptions" [ngValue]="p.codigoAnp">
            {{ p.codigoAnp }}{{ p.nome ? (' — ' + p.nome) : '' }}
          </option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label" for="cadTipo">Tipo *</label>
        <select id="cadTipo" class="form-select" [(ngModel)]="movForm.tipo">
          <option [ngValue]="undefined">Selecione…</option>
          <option [ngValue]="'ENTRADA'">ENTRADA</option>
          <option [ngValue]="'SAIDA'">SAÍDA</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label" for="cadQtd">Quantidade *</label>
        <input id="cadQtd" type="number" step="0.000001" class="form-control" [(ngModel)]="movForm.quantidade">
      </div>

      <div class="col-12 d-flex justify-content-end gap-2">
        <button class="btn btn-outline-secondary" (click)="mostrarCadastro = false">Cancelar</button>
        <button class="btn btn-secondary" [disabled]="movSalvando" (click)="registrarMovimento()">
          Registrar
        </button>
      </div>

    </div>
  </div>
</div>

<!-- TABELA DE MOVIMENTOS -->
<div class="table-responsive">
  <table class="table table-sm table-striped">
    <thead class="table-light">
      <tr>
        <th>Lote</th>
        <th>Tipo Químico</th>
        <th>Poço</th>
        <th>Tipo</th>
        <th>Quantidade</th>
        <th>Criado em</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let m of movRowsFiltrados; trackBy: trackMov">
        <td>{{ m.lote || '-' }}</td>
        <td>{{ m.tipoQuimico || '-' }}</td>
        <td>{{ m.pocoCodigoAnp }}</td>
        <td>{{ m.tipoMovimento }}</td>
        <td>{{ m.qntMovimentada }}</td>
        <td>{{ m.criadoEm | date:'yyyy-MM-dd HH:mm' }}</td>
      </tr>

      <tr *ngIf="!movLoading && movRowsFiltrados.length === 0">
        <td colspan="6" class="text-center text-muted">Sem movimentos.</td>
      </tr>

      <tr *ngIf="movLoading">
        <td colspan="6" class="text-center text-muted">Carregando…</td>
      </tr>
    </tbody>
  </table>
</div>
