<div class="card-soft p-4 mb-4">
  <div class="row g-4 align-items-end"> <div class="col-12 d-flex justify-content-between align-items-center border-bottom pb-3 mb-3 border-light">
      <div class="d-flex gap-3">
        <button class="btn btn-primary fw-semibold px-4"
                (click)="carregarTodos()"
                [disabled]="movLoading">
          <span *ngIf="movLoading" class="spinner-border spinner-border-sm me-1"></span>
          Carregar Todos
        </button>
        <button class="btn btn-outline-secondary px-4"
                (click)="movRows = []"
                [disabled]="movLoading">
          Limpar Lista
        </button>
      </div>

      <button class="btn btn-success fw-semibold"
              (click)="mostrarCadastro = !mostrarCadastro"
              [disabled]="movLoading"
              style="padding: 0.6rem 1.2rem; border-radius: 8px;">
        <i class="bi bi-plus-lg me-1"></i> Nova Movimentação
      </button>
    </div>

    <div class="col-12">
      <h6 class="text-muted fw-bold mb-3" style="font-size: 0.85rem;">FILTROS DE BUSCA RÁPIDA</h6>
      <div class="row g-3">

        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label small text-muted fw-bold mb-2" for="filtroTipoQuimico">Tipo de Químico</label>
          <div class="input-group">
            <select id="filtroTipoQuimico"
                    class="form-select"
                    [(ngModel)]="selectedTipoQuimico">
              <option [ngValue]="undefined">Selecione um tipo...</option>
              <option *ngFor="let t of tiposOptions" [ngValue]="t">{{ t }}</option>
            </select>
            <button class="btn btn-outline-primary"
                    (click)="carregarMovPorTipoQuimico(selectedTipoQuimico)"
                    [disabled]="!selectedTipoQuimico || movLoading"
                    title="Buscar por Tipo">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label small text-muted fw-bold mb-2" for="filtroTipoMov">Tipo de Movimento</label>
          <div class="input-group">
            <select id="filtroTipoMov"
                    class="form-select"
                    [(ngModel)]="selectedTipoMov">
              <option [ngValue]="undefined">Selecione...</option>
              <option [ngValue]="'ENTRADA'">ENTRADA</option>
              <option [ngValue]="'SAIDA'">SAÍDA</option>
            </select>
            <button class="btn btn-outline-primary"
                    (click)="carregarMovPorTipoMovimento(selectedTipoMov)"
                    [disabled]="!selectedTipoMov || movLoading"
                    title="Buscar por Tipo de Movimento">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label small text-muted fw-bold mb-2" for="filtroPoco">Poço (código ANP)</label>
          <div class="input-group">
            <select id="filtroPoco"
                    class="form-select"
                    [(ngModel)]="movForm.pocoCodigoAnp"
                    (ngModelChange)="onPocoChange($event)">
              <option [ngValue]="null">Selecione um poço...</option>
              <option *ngFor="let p of pocosOptions" [ngValue]="p.codigoAnp">
                {{ p.codigoAnp }}{{ p.nome ? (' — ' + p.nome) : '' }}
              </option>
            </select>
            <button class="btn btn-outline-primary"
                    (click)="carregarMovPorPoco(movForm.pocoCodigoAnp)"
                    [disabled]="!movForm.pocoCodigoAnp || movLoading"
                    title="Buscar por Poço">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <small class="text-muted small" *ngIf="movForm.pocoCodigoAnp">
            Selecionado: "{{ movForm.pocoCodigoAnp }}"
          </small>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label small text-muted fw-bold mb-2" for="buscaLote">Pesquisar por Lote</label>
          <input id="buscaLote"
                type="text"
                class="form-control"
                placeholder="Digite o lote..."
                [(ngModel)]="loteQuery">
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card-soft mb-4 p-4 border-start border-4 border-primary" *ngIf="mostrarCadastro">
  <div class="row g-4 align-items-end">
    
    <div class="col-12 mb-2">
      <h5 class="fw-bold m-0" style="color: #1a1f36;"><i class="bi bi-journal-check me-2 text-primary"></i> Registrar Novo Movimento</h5>
    </div>

    <div class="col-md-3">
      <label class="form-label small text-muted fw-bold" for="cadQuimico">Químico *</label>
      <select id="cadQuimico"
              class="form-select"
              [(ngModel)]="movForm.quimicoCodigo">
        <option [ngValue]="undefined">Selecione…</option>
        <option *ngFor="let q of quimicosOptions" [ngValue]="q.codigo">
          {{ (q.lote || '—') }} - {{ (q.tipoQuimico || '—') }} - {{ (q.estadoLocalArmazenamento || '—') }}
        </option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label small text-muted fw-bold" for="cadPoco">Poço (código ANP) *</label>
      <select id="cadPoco"
              class="form-select"
              [(ngModel)]="movForm.pocoCodigoAnp"
              (ngModelChange)="onPocoChange($event)">
        <option [ngValue]="null">Selecione…</option>
        <option *ngFor="let p of pocosOptions" [ngValue]="p.codigoAnp">
          {{ p.codigoAnp }}{{ p.nome ? (' — ' + p.nome) : '' }}
        </option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label small text-muted fw-bold" for="cadTipo">Tipo *</label>
      <select id="cadTipo"
              class="form-select"
              [(ngModel)]="movForm.tipo">
        <option [ngValue]="undefined">Selecione…</option>
        <option [ngValue]="'ENTRADA'">ENTRADA</option>
        <option [ngValue]="'SAIDA'">SAÍDA</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label small text-muted fw-bold" for="cadQtd">Quantidade *</label>
      <input id="cadQtd"
              type="number"
              step="0.000001"
              class="form-control"
              [(ngModel)]="movForm.quantidade">
    </div>

    <div class="col-12 d-flex justify-content-end gap-2 border-top pt-3">
      <button class="btn btn-outline-secondary"
              (click)="mostrarCadastro = false">
        Cancelar
      </button>
      <button class="btn btn-success fw-semibold"
              [disabled]="movSalvando"
              (click)="registrarMovimento()">
        <span *ngIf="movSalvando" class="spinner-border spinner-border-sm me-2"></span>
        Registrar
      </button>
    </div>

    <div class="col-12">
      <div class="alert alert-danger floating-alert"
           *ngIf="alertError"
           role="alert"
           style="font-size: 0.9rem;">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ alertErrorMsg }}
      </div>
    </div>

  </div>
</div>

<div class="table-container">
  <div class="table-responsive">
    <table class="table-soft" style="width: 100%;"> <thead class="table-light">
        <tr>
          <th class="ps-4">Lote</th>
          <th>Tipo Químico</th>
          <th>Poço</th>
          <th>Tipo</th>
          <th class="text-center">Quantidade</th>
          <th>Criado em</th>
          <th class="text-end pe-4">Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let m of movRowsFiltrados; trackBy: trackMov">
          <td class="ps-4 fw-semibold text-dark">{{ getLote(m) }}</td>
          <td>
            <span style="background: #eef2ff; color: #4f46e5; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 0.75rem;">
                {{ getTipoQuimico(m) }}
            </span>
          </td>
          <td class="text-muted">{{ getPocoCodigo(m) }}</td>
          <td>
            <span class="fw-bold" 
                  [class.text-success]="m.tipoMovimento === 'ENTRADA'"
                  [class.text-danger]="m.tipoMovimento === 'SAIDA'">
                {{ m.tipoMovimento }}
            </span>
          </td>
          <td class="text-center fw-bold"
              [class.text-success]="m.tipoMovimento === 'ENTRADA'"
              [class.text-danger]="m.tipoMovimento === 'SAIDA'">
              {{ m.qntMovimentada }}
          </td>
          <td class="text-muted">{{ m.criadoEm | date:'yyyy-MM-dd HH:mm' }}</td>
          <td class="text-end pe-4">
            <button class="btn btn-sm btn-light border"
                    (click)="deletarMovimento(m)"
                    [disabled]="movLoading"
                    title="Excluir Movimento"
                    style="color: #ef4444;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                  <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                </svg>
            </button>
          </td>
        </tr>

        <tr *ngIf="!movLoading && movRowsFiltrados.length === 0">
          <td colspan="7" class="text-center p-5 text-muted">
            <h6 class="text-muted fw-medium mb-0">Nenhum movimento encontrado.</h6>
          </td>
        </tr>

        <tr *ngIf="movLoading">
          <td colspan="7" class="text-center p-3 text-muted">
            <span class="spinner-border spinner-border-sm me-2 text-primary"></span> Carregando movimentos...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>