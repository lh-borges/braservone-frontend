<div class="shell">
  <app-header class="header"></app-header>

  <aside class="sidebar border-end">
    <app-menu-lateral></app-menu-lateral>
  </aside>

  <main class="content">
    <div class="container-fluid">
      <div class="row">
        <!-- Topo / Banner -->
        <div class="col-12">
          <div
            class="rounded p-4 m-3 bg-primary d-flex flex-wrap gap-2 justify-content-between align-items-center shadow-sm">
            <h2 class="text-white fw-bold m-0">Reportes de Campo</h2>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-light fw-semibold" (click)="load()" [disabled]="loading()">
                <span *ngIf="loading()" class="spinner-border spinner-border-sm me-1" role="status"></span>
                Recarregar
              </button>
            </div>
          </div>
        </div>

        <!-- Estados globais -->
        <div class="col-12">
          <div class="m-3" *ngIf="errorMsg()">
            <div class="alert alert-danger mb-0">{{ errorMsg() }}</div>
          </div>
          <div class="m-3" *ngIf="loading()">
            <div class="alert alert-light d-flex align-items-center gap-2 mb-0">
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              <span>Carregando‚Ä¶</span>
            </div>
          </div>
        </div>

        <!-- ===================== Em andamento (com filtros) ===================== -->
        <div class="col-12" *ngIf="!loading() && !errorMsg()">
          <div class="card shadow-sm m-3">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-2">
                <span class="text-danger">üìå</span>
                <span class="fw-semibold">Em andamento</span>
              </div>
              <span class="badge text-bg-primary">{{ abertosFiltrados().length }}</span>
            </div>

            <div class="card-body">

              <!-- Filtro toolbar -->
              <div class="border rounded-3 p-3 mb-3 bg-light">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-5">
                    <label class="form-label mb-1">Filtrar por Setor</label>
                    <select class="form-select"
                            [ngModel]="filtroSetor()"
                            (ngModelChange)="filtroSetor.set($event)">
                      <option [ngValue]="'TODOS'">Todos</option>
                      <option *ngFor="let s of setorOptions" [ngValue]="s">{{ setorLabel(s) }}</option>
                    </select>
                  </div>

                  <div class="col-12 col-md-5">
                    <label class="form-label mb-1">Filtrar por Status</label>
                    <select class="form-select"
                            [ngModel]="filtroStatus()"
                            (ngModelChange)="filtroStatus.set($event)">
                      <option [ngValue]="'TODOS'">Todos</option>
                      <option *ngFor="let s of openStatusOptions" [ngValue]="s">{{ s }}</option>
                    </select>
                  </div>

                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-secondary" (click)="clearFilters()">Limpar</button>
                  </div>
                </div>
              </div>

              <ng-container *ngIf="abertosFiltrados().length; else vazioAbertos">
                <div class="row g-3">
                  <div class="col-xl-3 col-lg-4 col-md-6" *ngFor="let r of abertosFiltrados()">
                    <div class="card h-100 shadow-lg border-0">
                      <div class="card-body d-flex flex-column">
                        <!-- Status + Data -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span
                            class="text-danger"
                            [ngClass]="{
                              'text-bg-success': r.status==='FINALIZADO',
                              'text-bg-danger' : r.status==='CANCELADO',
                              'text-bg-secondary': r.status!=='FINALIZADO' && r.status!=='CANCELADO'
                            }">
                            {{ r.status }}
                          </span>
                          <small class="text-muted">{{ r.dataHoraReporte | date:'dd/MM/yyyy HH:mm' }}</small>
                        </div>

                        <!-- Mensagem -->
                        <h6 class="card-title fw-bold text-primary mb-2 text-truncate" title="{{ r.mensagem }}">
                          {{ r.mensagem }}
                        </h6>

                        <!-- Metadados -->
                        <ul class="list-unstyled small text-muted mb-0">
                          <li>
                            <i class="bi bi-person-badge me-1"></i>
                            Matr√≠cula: <strong class="text-body">{{ r.matricula }}</strong>
                          </li>
                          <li>
                            <i class="bi bi-diagram-3 me-1"></i>
                            Setor: <strong class="text-body">{{ setorLabel(r.setor) }}</strong>
                          </li>
                          <li>
                            <i class="bi bi-chat-dots me-1"></i>
                            Observa√ß√µes: <strong class="text-body">{{ countObs(r) }}</strong>
                          </li>
                        </ul>

                        <!-- Select de status + bot√µes -->
                        <div class="mt-auto pt-3 d-flex align-items-center justify-content-between flex-wrap gap-2">
                          <div class="d-flex align-items-center gap-2">
                            <label class="small text-muted mb-0">Status:</label>
                            <select class="form-select form-select-sm w-auto"
                                    [ngModel]="r.status"
                                    (ngModelChange)="onStatusChange(r, $event)"
                                    [disabled]="updating.has(r.id)">
                              <option *ngFor="let s of statusOptions" [value]="s">{{ s }}</option>
                            </select>
                          </div>

                          <div class="d-flex gap-2 ms-auto">
                            
                            <button class="btn btn-outline-primary btn-sm" (click)="onView(r)">
                              <i class="bi bi-eye-fill me-1"></i> Visualizar
                            </button>
                            <!-- Bot√£o de excluir -->
                            <button class="btn btn-outline-danger btn-sm"
                                    (click)="onDelete(r)"
                                    [disabled]="deleting.has(r.id)">
                              <span *ngIf="deleting.has(r.id)"
                                    class="spinner-border spinner-border-sm me-1"
                                    role="status"
                                    aria-hidden="true"></span>
                              <i class="bi bi-trash3-fill me-1"></i> Excluir
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div> <!-- /col -->
                </div> <!-- /row -->
              </ng-container>

              <ng-template #vazioAbertos>
                <div class="border rounded-3 bg-white p-4 text-center text-muted">
                  Nenhum reporte em andamento.
                </div>
              </ng-template>
            </div> <!-- /card-body -->
          </div> <!-- /card -->
        </div> <!-- /col-12 Em andamento -->

        <!-- ===================== Encerrados ===================== -->
        <div class="col-12" *ngIf="!loading() && !errorMsg()">
          <div class="card shadow-sm m-3">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-2">
                <span class="text-success">‚úÖ</span>
                <span class="fw-semibold">Encerrados</span>
              </div>
              <span class="badge text-bg-secondary">{{ encerrados().length }}</span>
            </div>

            <div class="card-body">
              <ng-container *ngIf="encerrados().length; else vazioEncerrados">
                <div class="row g-3">
                  <div class="col-xl-3 col-lg-4 col-md-6" *ngFor="let r of encerrados()">
                    <div class="card h-100 shadow-lg border-0">
                      <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span class="badge"
                                [ngClass]="{
                                  'text-bg-success': r.status==='FINALIZADO',
                                  'text-bg-danger' : r.status==='CANCELADO',
                                  'text-bg-secondary': r.status!=='FINALIZADO' && r.status!=='CANCELADO'
                                }">
                            {{ r.status }}
                          </span>
                          <small class="text-muted">{{ r.dataHoraReporte | date:'dd/MM/yyyy HH:mm' }}</small>
                        </div>

                        <h6 class="card-title fw-bold mb-2 text-truncate" title="{{ r.mensagem }}">
                          {{ r.mensagem }}
                        </h6>

                        <ul class="list-unstyled small text-muted mb-0">
                          <li>
                            <i class="bi bi-person-badge me-1"></i>
                            Matr√≠cula: <strong class="text-body">{{ r.matricula }}</strong>
                          </li>
                          <li>
                            <i class="bi bi-diagram-3 me-1"></i>
                            Setor: <strong class="text-body">{{ setorLabel(r.setor) }}</strong>
                          </li>
                          <li>
                            <i class="bi bi-chat-dots me-1"></i>
                            Observa√ß√µes: <strong class="text-body">{{ countObs(r) }}</strong>
                          </li>
                        </ul>

                        <div class="mt-auto pt-3 d-flex align-items-center justify-content-between flex-wrap gap-2">
                          <div class="d-flex align-items-center gap-2">
                            <label class="small text-muted mb-0">Status:</label>
                            <select class="form-select form-select-sm w-auto"
                                    [ngModel]="r.status"
                                    (ngModelChange)="onStatusChange(r, $event)"
                                    [disabled]="updating.has(r.id)">
                              <option *ngFor="let s of statusOptions" [value]="s">{{ s }}</option>
                            </select>
                          </div>

                          <div class="d-flex gap-2 ms-auto">
                            <button class="btn btn-outline-secondary btn-sm"
                                    (click)="onAddObs(r)"
                                    [disabled]="addingObs.has(r.id)">
                              <span *ngIf="addingObs.has(r.id)"
                                    class="spinner-border spinner-border-sm me-1"></span>
                              <i class="bi bi-plus-circle me-1"></i> Adicionar Observa√ß√£o
                            </button>
                            <button class="btn btn-outline-primary btn-sm" (click)="onView(r)">
                              <i class="bi bi-eye-fill me-1"></i> Visualizar
                            </button>
                            <!-- Bot√£o de excluir -->
                            <button class="btn btn-outline-danger btn-sm"
                                    (click)="onDelete(r)"
                                    [disabled]="deleting.has(r.id)">
                              <span *ngIf="deleting.has(r.id)"
                                    class="spinner-border spinner-border-sm me-1"
                                    role="status"
                                    aria-hidden="true"></span>
                              <i class="bi bi-trash3-fill me-1"></i> Excluir
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div> <!-- /col -->
                </div> <!-- /row -->
              </ng-container>

              <ng-template #vazioEncerrados>
                <div class="border rounded-3 bg-white p-4 text-center text-muted">
                  Nada encerrado por aqui.
                </div>
              </ng-template>
            </div> <!-- /card-body -->
          </div> <!-- /card -->
        </div> <!-- /col-12 Encerrados -->

      </div> <!-- /row -->
    </div> <!-- /container-fluid -->
  </main>
</div>
