<div class="shell">
  <!-- Header -->
  <app-header class="header"></app-header>

  <!-- Sidebar -->
  <aside class="sidebar border-end">
    <app-menu-lateral></app-menu-lateral>
  </aside>

  <!-- Content -->
  <main class="content">
    <div class="container-fluid">
      <div class="row">

        <!-- DADOS DO USUÁRIO -->
        <div class="centralizado border rounded p-3 my-3" *ngIf="user">
          <h1 class="h3 mb-3">Usuário</h1>

          <form class="row g-3" (ngSubmit)="updateUser()" #userForm="ngForm">
            <!-- Nome -->
            <div class="col-sm-6">
              <label for="nome" class="form-label">Nome</label>
              <input
                type="text"
                id="nome"
                class="form-control"
                [(ngModel)]="user.nome"
                name="nome"
              />
            </div>

            <!-- Username -->
            <div class="col-sm-6">
              <label for="username" class="form-label">Username</label>
              <input
                type="text"
                id="username"
                class="form-control"
                [(ngModel)]="user.username"
                name="username"
                readonly
              />
            </div>

            <!-- Email -->
            <div class="col-sm-6">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                id="email"
                class="form-control"
                [(ngModel)]="user.email"
                name="email"
              />
            </div>

            <!-- Mensagem + botão alinhado à direita -->
            <div class="col-12 d-flex align-items-center mt-2">
              <div class="me-3 small">
                <span *ngIf="saveSuccess" class="text-success">✓ Usuário atualizado com sucesso</span>
                <span *ngIf="saveError" class="text-danger">✗ {{ saveError }}</span>
              </div>

              <button
                type="submit"
                class="btn btn-primary ms-auto"
                [disabled]="loading"
              >
                <ng-container *ngIf="!loading; else spinnerUser">
                  Atualizar
                </ng-container>
                <ng-template #spinnerUser>
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Carregando...
                </ng-template>
              </button>
            </div>
          </form>
        </div>

        <!-- TROCAR SENHA -->
        <div class="centralizado border rounded p-3 my-3">
          <form class="row g-3" (ngSubmit)="changePassword()" #pwdForm="ngForm" novalidate>
            <h1 class="h3">Trocar Senha</h1>

            <!-- Senha atual -->
            <div class="col-sm-4">
              <label for="oldPassword" class="form-label">Senha atual</label>
              <input
                type="password"
                id="oldPassword"
                class="form-control"
                name="oldPassword"
                [(ngModel)]="oldPassword"
                required
                minlength="6"
                #oldPwd="ngModel"
                [class.is-invalid]="(oldPwd.invalid && (oldPwd.touched || pwdForm.submitted))"
                aria-describedby="oldPwdErrors"
              />
              <div id="oldPwdErrors" class="invalid-feedback d-block" *ngIf="oldPwd.invalid && (oldPwd.touched || pwdForm.submitted)">
                <div *ngIf="oldPwd.errors?.['required']">Campo obrigatório.</div>
                <div *ngIf="oldPwd.errors?.['minlength']">Mínimo de 6 caracteres.</div>
              </div>
            </div>

            <!-- Nova senha -->
            <div class="col-sm-4">
              <label for="password" class="form-label">Nova senha</label>
              <input
                type="password"
                id="password"
                class="form-control"
                name="password"
                [(ngModel)]="password"
                required
                minlength="6"
                #pwd="ngModel"
                [class.is-invalid]="(pwd.invalid && (pwd.touched || pwdForm.submitted))"
                aria-describedby="pwdErrors"
              />
              <div id="pwdErrors" class="invalid-feedback d-block" *ngIf="pwd.invalid && (pwd.touched || pwdForm.submitted)">
                <div *ngIf="pwd.errors?.['required']">Campo obrigatório.</div>
                <div *ngIf="pwd.errors?.['minlength']">Mínimo de 6 caracteres.</div>
              </div>
            </div>

            <!-- Confirmar nova senha -->
            <div class="col-sm-4">
              <label for="confirmPassword" class="form-label">Confirmar nova senha</label>
              <input
                type="password"
                id="confirmPassword"
                class="form-control"
                name="confirmPassword"
                [(ngModel)]="confirmPassword"
                required
                minlength="6"
                #confirmPwd="ngModel"
                [class.is-invalid]="((confirmPwd.invalid || password !== confirmPassword) && (confirmPwd.touched || pwdForm.submitted))"
                aria-describedby="confirmPwdErrors"
              />
              <div id="confirmPwdErrors" class="invalid-feedback d-block"
                   *ngIf="(confirmPwd.invalid || password !== confirmPassword) && (confirmPwd.touched || pwdForm.submitted)">
                <div *ngIf="confirmPwd.errors?.['required']">Campo obrigatório.</div>
                <div *ngIf="confirmPwd.errors?.['minlength']">Mínimo de 6 caracteres.</div>
                <div *ngIf="!confirmPwd.errors && password !== confirmPassword">As senhas não coincidem.</div>
              </div>
            </div>

            <!-- Mensagem + botão alinhado à direita -->
            <div class="col-12 d-flex align-items-center mt-3">
              <div class="me-3 small">
                <span *ngIf="pwdSuccess" class="text-success">✓ Senha alterada com sucesso!</span>
                <span *ngIf="pwdError" class="text-danger">✗ Erro ao alterar senha!</span>
              </div>

              <button
                type="submit"
                class="btn btn-success ms-auto"
                [disabled]="pwdLoading || !pwdForm.form.valid || password !== confirmPassword"
              >
                <ng-container *ngIf="!pwdLoading; else pwdSpinner">
                  Alterar senha
                </ng-container>
                <ng-template #pwdSpinner>
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Carregando...
                </ng-template>
              </button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </main>
</div>
